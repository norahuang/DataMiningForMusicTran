"use strict";var Membership=function(b){this.debug=false;this.config=b;this.config_once=[];this.status=1;if(b.debug!=undefined&&b.debug){this.debug=b.debug}if(b.env=="dev"||b.env=="staging"){this.debug=true}if(!b||b==undefined){console.log("M.CLASS ERROR: Membership is not configured");return false}this.log=function(g){if(this.debug){console.log("MEMBERSHIP LOG: ",g)}};this.listener=this.listener.bind(this);this.onclick=this.onclick.bind(this);if(window.addEventListener){window.addEventListener("message",this.listener,false);window.addEventListener("click",this.onclick,false)}else{window.attachEvent("onmessage",this.listener);window.attachEvent("click",this.onclick)}if(!document.getElementById("MemJsIframe")){var d;var a=document.getElementsByTagName("body");d=document.createElement("iframe");d.id="MemJsIframe";d.style.width="0";d.style.height="0";d.src=this._getParam("pw_host")+"/integration?v1.1";document.body.appendChild(d);this.log("MemJsIframe - created")}if(!document.getElementById("MemCssIframe")){var e;var c=document.getElementsByTagName("head");e=document.createElement("link");e.id="MemCssIframe";e.rel="stylesheet";e.href=this._getParam("pw_host")+"/css/popup_wrapper.css";document.body.appendChild(e);this.log("MemCssIframe - created")}if(this.getCookie("__pwt")){this.log("remove old token");var f=this.getCookie("__pwt");this.delCookie("__pwt");this.setCookie("pw_token",f)}};Membership.prototype.sendEvent=function(b,a){this.log({type:b,value:a});top.postMessage({type:b,value:a},"*")};Membership.prototype.onclick=function(a){switch(a.target.getAttribute("id")){case"closeMembershipPopUp":this.closeMembershipModal(null);break}a=null};Membership.prototype.closeMembershipModal=function(b){var a=this.isOpenModal();if(a){this.sendEvent("pw_modal_closed",b);a.style.visibility="hidden";a.remove()}};Membership.prototype.isOpenModal=function(){var a=document.getElementById("paper-wall-auth-content");if(a){return a}return false};Membership.prototype.listener=function(e){try{var c=e.data;var f=this.getCookie("__pwt");var a=this.getCookie("pw_token");if(c&&c.type=="callback"&&c.value!=null){c.type=c.value;c.value=true}if(c&&c.type=="token"&&c.value){this.log("token:"+c.value);localStorage.setItem("__out_c",0);this.setCookie("pw_token",c.value)}if(c&&c.type=="pw_public_token"&&c.value&&c.value!=a&&!this.isOpenModal()){this.status=0;this.log("public token:"+c.value);this.setCookie("pw_token",c.value);localStorage.setItem("__out_c",0);window.location.reload()}if(c&&c.type=="pw_close_modal"&&c.value!=null){this.closeMembershipModal(null)}if(c&&c.type=="pw_reload_page"){window.location.reload()}if(c&&c.type=="pw_public_logout"){if((typeof a!=="null"&&typeof a!=="undefined"&&a!=undefined&&a!="")||(typeof f!=="null"&&typeof f!=="undefined"&&f!=undefined&&f!="")){var b=localStorage.getItem("__out_c");if(b<=0||b==undefined||b==null||b==""){b=1;localStorage.setItem("__out_c",b)}this.delCookie("__pwt");this.delCookie("pw_token");this.closeMembershipModal("logout");localStorage.removeItem("pw_token");this.sendEvent("pw_deja_vu",true);if(b<3){++b;localStorage.setItem("__out_c",b);window.location.reload()}else{++b;localStorage.setItem("__out_c",b)}}}if(c&&c.type=="pw-logout"||c&&c.type=="pw_logout"){this.delCookie("pw_token");this.closeMembershipModal("logout");if(typeof a!=="null"&&typeof a!=="undefined"&&a!=undefined&&a!=""){window.location.reload()}localStorage.removeItem("pw_token")}if(c&&c.type=="IntegrationJs"){if(this.status){this.sendEvent("pw_ready",true)}}}catch(d){}};Membership.prototype._getHtmlModal=function(a){return'<div class="membership-popup-wrapper" id="paper-wall-auth-content">    <div class="membership-popup">       <div class="top-perspective-block">                   </div>       <div class="right-perspective-block">                   </div>       <div class="bottom-perspective-block">                   </div>       <div class="left-perspective-block">                              </div>       <div class="popup-container">           <a href="#" class="cancel" id="closeMembershipPopUp"></a>           <iframe id="pw_popup_container_iframe" sandbox="allow-same-origin allow-scripts allow-popups allow-forms" src="'+a+'" frameborder="0" scrolling="no" width="100%"></iframe>       </div>    </div></div>'};Membership.prototype.log=function(a){if(this.debug){console.log("MEMBERSHIP LOG: ",a)}};Membership.prototype._build_http_query=function(b){for(var a in this.config){if(this.config.hasOwnProperty(a)&&this.config[a]){if(a=="pw_host"){continue}b=b+a+"="+encodeURIComponent(this.config[a])+"&"}}for(var a in this.config_once){if(this.config_once.hasOwnProperty(a)&&this.config_once[a]){b=b+a+"="+encodeURIComponent(this.config_once[a])+"&";this.config_once[a]=undefined}}return b};Membership.prototype._getParam=function(b){var a=null;if(this.config[b]!=undefined&&this.config[b]){a=this.config[b]}if(this.config_once[b]!=undefined&&this.config_once[b]){a=this.config_once[b];this.config_once[b]=undefined}return a};Membership.prototype._createElement=function(b){var c=document.createDocumentFragment(),a=document.createElement("div");
a.innerHTML=b;while(a.firstChild){c.appendChild(a.firstChild)}return c};Membership.prototype.OpenModal=function(d){if(this.getCookie("pw_token")){this.config=this._merge(this.config,{token:this.getCookie("pw_token")})}else{this.config=this._merge(this.config,{token:this.getCookie("__pwt")})}var a=this._getParam("pw_host");if(d!=undefined&&d!="null"&&d){a+=d+"?"}else{a+="/auth?"}var c=document.getElementById("paper-wall-auth-content");if(!c||c==undefined||c==null){this.log("Create modal");var b=this._getHtmlModal(this._build_http_query(a));document.body.insertBefore(this._createElement(b),document.body.childNodes[0]);c=document.getElementById("paper-wall-auth-content")}else{this.log("Modal already created, shown");document.getElementById("pw_popup_container_iframe").setAttribute("src",this._build_http_query(a))}c.style.visibility="visible"};Membership.prototype.setParam=function(a){if(a!=undefined&&a){this.config=this._merge(this.config,a)}};Membership.prototype.setParamOnce=function(a){if(a!=undefined&&a){this.config_once=this._merge(this.config_once,a)}};Membership.prototype._merge=function(d,c){for(var b in c){try{if(c[b].constructor==Object){d[b]=this._merge(d[b],c[b])}else{d[b]=c[b]}}catch(a){d[b]=c[b]}}return d};Membership.prototype.setCookie=function(b,f,h,e,g){this.log("COOKIE SET "+b+" : "+f);var d=new Date();var a=new Date(d.getTime()+(365*86400000));f=encodeURIComponent(f);var c=b+"="+f+((a)?"; expires="+a.toGMTString():"")+"; path=/"+((g)?"; secure":"");document.cookie=c};Membership.prototype.getCookie=function(a){var b=document.cookie.match(new RegExp("(?:^|; )"+a.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)"));return b?decodeURIComponent(b[1]):undefined};Membership.prototype.delCookie=function(a){document.cookie=a+"=; path=/; domain="+document.location.hostname+";expires=Thu, 01-Jan-70 00:00:01 GMT";document.cookie=a+"=; path=/;expires=Thu, 01-Jan-70 00:00:01 GMT"};function bind(b,a){return function(){return b.apply(a,arguments)}};